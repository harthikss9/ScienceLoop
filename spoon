#!/usr/bin/env python3
"""
Spoon CLI wrapper - Runs agents defined in spoon.json
"""

import sys
import json
import subprocess
import argparse
from pathlib import Path

def load_spoon_config():
    """Load spoon.json configuration."""
    config_path = Path("spoon.json")
    if not config_path.exists():
        print("Error: spoon.json not found", file=sys.stderr)
        sys.exit(1)
    
    with open(config_path, 'r') as f:
        return json.load(f)

def run_agent(agent_name, args_dict):
    """Run an agent with given arguments."""
    config = load_spoon_config()
    
    if "agents" not in config:
        print("Error: No agents defined in spoon.json", file=sys.stderr)
        sys.exit(1)
    
    if agent_name not in config["agents"]:
        print(f"Error: Agent '{agent_name}' not found in spoon.json", file=sys.stderr)
        print(f"Available agents: {', '.join(config['agents'].keys())}", file=sys.stderr)
        sys.exit(1)
    
    agent_config = config["agents"][agent_name]
    agent_path = Path(agent_config["path"])
    
    if not agent_path.exists():
        print(f"Error: Agent file not found: {agent_path}", file=sys.stderr)
        sys.exit(1)
    
    # Build command
    cmd = ["python3", str(agent_path)]
    
    # Add arguments
    for key, value in args_dict.items():
        if value is not None:
            cmd.extend([f"--{key}", str(value)])
    
    # Run the agent
    try:
        result = subprocess.run(cmd, check=False)
        sys.exit(result.returncode)
    except KeyboardInterrupt:
        print("\nInterrupted", file=sys.stderr)
        sys.exit(130)
    except Exception as e:
        print(f"Error running agent: {e}", file=sys.stderr)
        sys.exit(1)

def main():
    parser = argparse.ArgumentParser(description="Spoon CLI - Run agents from spoon.json")
    parser.add_argument("command", choices=["run"], help="Command to execute")
    parser.add_argument("agent_name", help="Name of the agent to run")
    
    # Parse known args first to get agent name
    args, remaining = parser.parse_known_args()
    
    if args.command == "run":
        # Load agent config to get required arguments
        config = load_spoon_config()
        if args.agent_name not in config["agents"]:
            print(f"Error: Agent '{args.agent_name}' not found", file=sys.stderr)
            sys.exit(1)
        
        agent_config = config["agents"][args.agent_name]
        agent_args = {}
        
        # Parse remaining arguments as --key value pairs
        i = 0
        while i < len(remaining):
            if remaining[i].startswith("--"):
                key = remaining[i][2:]  # Remove --
                if i + 1 < len(remaining) and not remaining[i + 1].startswith("--"):
                    value = remaining[i + 1]
                    agent_args[key] = value
                    i += 2
                else:
                    agent_args[key] = True
                    i += 1
            else:
                i += 1
        
        run_agent(args.agent_name, agent_args)
    else:
        parser.print_help()
        sys.exit(1)

if __name__ == "__main__":
    main()

